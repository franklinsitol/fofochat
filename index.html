<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FF9BB3">
    <meta name="description" content="BunnyChat - Mensagens Fofinhas e Seguras">
    <title>BunnyChat - Mensagens Fofinhas</title>
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ícones para PWA -->
    <link rel="icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- CSS e Fontes -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Short+Stack&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* [Seu CSS existente permanece exatamente o mesmo] */
    </style>
</head>
<body>
    <!-- [Seu HTML existente permanece exatamente o mesmo] -->

    <script>
        // Configuração do Gun.js
        const gun = Gun({
            peers: ['https://gun-manhattan.herokuapp.com/gun'],
            localStorage: false, // Desativado para evitar duplicação
            radisk: false       // Desativado para evitar duplicação
        });

        // Estado da aplicação
        const state = {
            currentUser: null,
            currentContact: null,
            contacts: {},
            messages: {},
            qrScanner: null,
            currentScreen: 'userSelect',
            pushNotifications: [],
            messageListeners: {},
            activeChat: null,
            lastScannedQR: null,
            processedMessages: new Set(),
            deferredPrompt: null,
            messageIds: new Set() // Novo: Para controlar IDs de mensagens
        };

        // [Seus elementos do DOM permanecem os mesmos]

        // Funções auxiliares
        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // [Outras funções auxiliares permanecem as mesmas]

        // Funções de mensagens - ATUALIZADAS
        function sendMessage(contactId, messageText) {
            if (!state.currentUser || !messageText.trim()) return;
            
            const messageId = generateMessageId();
            const message = {
                id: messageId,
                sender: state.currentUser.id,
                receiver: contactId,
                text: messageText,
                timestamp: Date.now(),
                read: false
            };
            
            // Verifica se a mensagem já foi processada
            if (state.messageIds.has(messageId)) return;
            state.messageIds.add(messageId);
            
            // Salva a mensagem para o remetente
            gun.get('users').get(state.currentUser.id).get('messages').get(messageId).put(message);
            
            // Salva a mensagem para o destinatário
            gun.get('users').get(contactId).get('messages').get(messageId).put(message);
            
            // Limpa o campo de mensagem
            elements.inputs.message.value = '';
        }

        function loadChatMessages(contactId) {
            if (!state.currentUser) return;
            
            elements.displays.chatMessages.innerHTML = '';
            
            gun.get('users').get(state.currentUser.id).get('messages').map().once((message, id) => {
                if (!message || isMessageExpired(message.timestamp) return;
                
                // Verifica se a mensagem é para/deste contato
                const isRelevant = (message.sender === contactId && message.receiver === state.currentUser.id) || 
                                  (message.sender === state.currentUser.id && message.receiver === contactId);
                
                if (!isRelevant) return;
                
                // Verifica se já processamos esta mensagem
                if (state.processedMessages.has(id)) return;
                state.processedMessages.add(id);
                
                const isSender = message.sender === state.currentUser.id;
                const senderName = isSender ? 'Você' : state.currentContact.name;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message-item';
                messageElement.style.alignItems = isSender ? 'flex-end' : 'flex-start';
                messageElement.style.backgroundColor = isSender ? 'var(--secondary)' : 'white';
                messageElement.innerHTML = `
                    <div class="message-header">
                        ${!isSender ? `<div class="avatar message-avatar">${generateAvatarIcon(state.currentContact.name)}</div>` : ''}
                        <div class="message-sender">${senderName}</div>
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                    </div>
                    <div class="message-content">
                        ${message.text}
                    </div>
                `;
                
                elements.displays.chatMessages.appendChild(messageElement);
                
                // Rolagem automática para a última mensagem
                elements.displays.chatMessages.scrollTop = elements.displays.chatMessages.scrollHeight;
                
                // Marca a mensagem como lida se for do outro usuário
                if (!isSender && !message.read) {
                    gun.get('users').get(state.currentUser.id).get('messages').get(id).put({
                        ...message,
                        read: true
                    });
                }
            });
            
            if (elements.displays.chatMessages.children.length === 0) {
                elements.displays.chatMessages.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <p>Nenhuma mensagem ainda</p>
                        <p>Envie uma mensagem para começar a conversa!</p>
                    </div>
                `;
            }
        }

        // Funções de QR Code - ATUALIZADAS
        function generateQrCode() {
            if (!state.currentUser) return;
            
            // Gera um novo token QR
            const qrToken = Math.random().toString(36).substr(2, 10);
            const qrData = JSON.stringify({
                type: 'bunnychat-contact',
                version: 1,
                userId: state.currentUser.id,
                token: qrToken,
                timestamp: Date.now()
            });
            
            // Atualiza o token no usuário
            gun.get('users').get(state.currentUser.id).put({
                ...state.currentUser,
                qrToken: qrToken,
                qrTokenTimestamp: Date.now()
            });
            
            // Gera o QR Code
            QRCode.toCanvas(elements.displays.qrCode, qrData, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#5A2A3E',
                    light: '#FFF2F5'
                }
            }, (error) => {
                if (error) console.error('Erro ao gerar QR Code:', error);
            });
            
            elements.displays.userId.value = state.currentUser.id;
        }

        function startQrScanner() {
            state.lastScannedQR = null;
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    elements.video.srcObject = stream;
                    elements.video.setAttribute('playsinline', true);
                    elements.video.play();
                    
                    elements.video.onplaying = () => {
                        elements.scanOverlay.style.display = 'none';
                    };
                    
                    function scanFrame() {
                        if (elements.video.readyState === elements.video.HAVE_ENOUGH_DATA) {
                            const canvas = document.createElement('canvas');
                            canvas.width = elements.video.videoWidth;
                            canvas.height = elements.video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(elements.video, 0, 0, canvas.width, canvas.height);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: 'dontInvert'
                            });
                            
                            if (code) {
                                try {
                                    const qrData = JSON.parse(code.data);
                                    
                                    // Verifica se é um QR Code válido do BunnyChat
                                    if (qrData.type === 'bunnychat-contact' && qrData.userId && qrData.token) {
                                        // Evitar processar o mesmo QR code múltiplas vezes
                                        if (state.lastScannedQR === qrData.userId) return;
                                        state.lastScannedQR = qrData.userId;
                                        
                                        // Verifica se não é o próprio usuário
                                        if (qrData.userId === state.currentUser.id) {
                                            showNotification('Você não pode adicionar a si mesmo!');
                                            return;
                                        }
                                        
                                        // Verifica o token no servidor
                                        gun.get('users').get(qrData.userId).once((user) => {
                                            if (user && user.qrToken === qrData.token) {
                                                // Verifica se o token ainda é válido (menos de 5 minutos)
                                                const tokenAge = Date.now() - (user.qrTokenTimestamp || 0);
                                                if (tokenAge < 5 * 60 * 1000) { // 5 minutos
                                                    stopQrScanner();
                                                    addContact(qrData.userId);
                                                } else {
                                                    showNotification('QR Code expirado. Peça para o contato gerar um novo.');
                                                }
                                            } else {
                                                showNotification('QR Code inválido');
                                            }
                                        });
                                    }
                                } catch (e) {
                                    console.error('Erro ao processar QR Code:', e);
                                }
                            }
                        }
                        
                        if (state.currentScreen === 'scan') {
                            requestAnimationFrame(scanFrame);
                        }
                    }
                    
                    scanFrame();
                })
                .catch(function(err) {
                    console.error('Erro ao acessar a câmera:', err);
                    elements.scanOverlay.innerHTML = `
                        <div>
                            <i class="fas fa-camera-slash"></i>
                            <p>Não foi possível acessar a câmera</p>
                            <button id="tryAgainBtn" class="btn btn-small" style="margin-top: 10px;">Tentar novamente</button>
                        </div>
                    `;
                    
                    document.getElementById('tryAgainBtn').addEventListener('click', startQrScanner);
                });
        }

        // [O restante do seu código permanece o mesmo]
    </script>
</body>
</html>
