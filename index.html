<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- ... (manter todo o head anterior) ... -->
</head>
<body>
    <!-- ... (manter toda a estrutura HTML anterior) ... -->

    <script>
        // ... (manter todo o código anterior até a função startQrScanner) ...

        // Inicia o scanner de QR Code (versão corrigida)
        function startQrScanner() {
            // Primeiro para qualquer scanner existente
            stopQrScanner();
            
            // Configurações da câmera
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            // Acessa a câmera
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    elements.displays.qrVideo.srcObject = stream;
                    elements.displays.qrVideo.setAttribute('playsinline', true); // Importante para iOS
                    elements.displays.qrVideo.play();
                    
                    // Cria canvas para análise
                    const canvasElement = document.createElement('canvas');
                    const canvas = canvasElement.getContext('2d', { willReadFrequently: true });
                    let scanning = true;
                    
                    // Função para processar cada frame
                    function tick() {
                        if (!scanning) return;
                        
                        try {
                            // Verifica se o vídeo está pronto
                            if (elements.displays.qrVideo.readyState === elements.displays.qrVideo.HAVE_ENOUGH_DATA) {
                                // Ajusta o canvas para o tamanho do vídeo
                                canvasElement.width = elements.displays.qrVideo.videoWidth;
                                canvasElement.height = elements.displays.qrVideo.videoHeight;
                                
                                // Desenha o frame do vídeo no canvas
                                canvas.drawImage(
                                    elements.displays.qrVideo, 
                                    0, 0, 
                                    canvasElement.width, 
                                    canvasElement.height
                                );
                                
                                // Obtém os dados da imagem para análise
                                const imageData = canvas.getImageData(
                                    0, 0, 
                                    canvasElement.width, 
                                    canvasElement.height
                                );
                                
                                // Tenta decodificar o QR Code
                                const code = jsQR(
                                    imageData.data,
                                    imageData.width,
                                    imageData.height,
                                    {
                                        inversionAttempts: 'dontInvert'
                                    }
                                );
                                
                                // Se encontrou um QR Code válido
                                if (code) {
                                    try {
                                        const qrData = JSON.parse(code.data);
                                        
                                        // Verifica se é um QR Code do BunnyChat
                                        if (qrData.app === "BunnyChat" && qrData.userId) {
                                            // Impede adicionar a si mesmo
                                            if (qrData.userId === state.currentUser.id) {
                                                alert('Você não pode adicionar a si mesmo!');
                                                return;
                                            }
                                            
                                            // Para o scanner
                                            stopQrScanner();
                                            
                                            // Adiciona o contato
                                            addContact(
                                                qrData.userId, 
                                                qrData.userName || 'Novo Contato'
                                            );
                                            
                                            return;
                                        }
                                    } catch (e) {
                                        console.log('QR Code inválido:', e);
                                    }
                                }
                            }
                            
                            // Continua escaneando
                            requestAnimationFrame(tick);
                        } catch (e) {
                            console.error('Erro no scanner:', e);
                            stopQrScanner();
                        }
                    }
                    
                    // Inicia o processo de escaneamento
                    tick();
                    
                    // Trata erros no elemento de vídeo
                    elements.displays.qrVideo.onerror = (e) => {
                        console.error('Erro no elemento de vídeo:', e);
                        stopQrScanner();
                    };
                })
                .catch(err => {
                    console.error('Erro ao acessar a câmera:', err);
                    alert('Não foi possível acessar a câmera. Verifique as permissões.');
                    
                    // Mostra mensagem mais amigável para o usuário
                    const errorMessage = 
                        err.name === 'NotAllowedError' ? 
                        'Permissão para acessar a câmera foi negada.' :
                        'Não foi possível acessar a câmera.';
                    
                    alert(errorMessage);
                });
        }

        // ... (manter o restante do código anterior) ...
    </script>
</body>
</html>
